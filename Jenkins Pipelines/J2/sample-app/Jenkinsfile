pipeline {
  agent any

  parameters {
    string(name: 'APP_PORT', defaultValue: '5050', description: 'Poort waarop de app draait')
    booleanParam(name: 'DEPLOY', defaultValue: true, description: 'Deploy na succesvolle test?')
  }

  environment {
    APP_NAME = "sampleapp"
    TEST_CONTAINER = "sampleapp_test"
    PROD_CONTAINER = "sampleapp_prod"
    IMAGE_TAG = "build-${env.BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Cleanup (safe)') {
      steps {
        script {
          sh """
            docker rm -f ${TEST_CONTAINER} 2>/dev/null || true
            docker rm -f ${PROD_CONTAINER} 2>/dev/null || true
          """
        }
      }
    }

    stage('Build Image') {
      steps {
        sh """
          # Hergebruik je lab build-script, maar maak een unieke tag
          bash ./sample-app.sh
          docker tag ${APP_NAME}:latest ${APP_NAME}:${IMAGE_TAG}
        """
      }
    }

    stage('Run Test Container') {
      steps {
        sh """
          docker run -d --name ${TEST_CONTAINER} -p ${APP_PORT}:${APP_PORT} ${APP_NAME}:${IMAGE_TAG}
          sleep 2
        """
      }
    }

    stage('Quality Gate (HTTP check)') {
      steps {
        sh """
          if curl -s http://172.17.0.1:${APP_PORT}/ | grep -q "You are calling me from"; then
            echo "TEST OK"
            exit 0
          else
            echo "TEST FAILED"
            docker logs ${TEST_CONTAINER} || true
            exit 1
          fi
        """
      }
    }

    stage('Deploy') {
      when { expression { return params.DEPLOY } }
      steps {
        sh """
          # Stop test container en start prod container met dezelfde image
          docker rm -f ${TEST_CONTAINER} 2>/dev/null || true
          docker run -d --name ${PROD_CONTAINER} -p ${APP_PORT}:${APP_PORT} ${APP_NAME}:${IMAGE_TAG}

          # Post-deploy check
          sleep 2
          curl -s http://172.17.0.1:${APP_PORT}/ | grep -q "You are calling me from"
        """
      }
    }
  }

  post {
    always {
      sh "docker rm -f ${TEST_CONTAINER} 2>/dev/null || true"
    }
    failure {
      echo "Pipeline faalde vóór deploy of tijdens checks. Geen production container gestart."
    }
    success {
      echo "Pipeline success. App zou bereikbaar moeten zijn op localhost:${params.APP_PORT}"
    }
  }
}
